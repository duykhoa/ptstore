<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<dom-module id="pt-feature-transition">
  <template>
    Total: {{features.length}} feature stories
    <template is="dom-repeat" items="{{features}}" as="feature">
      <pt-feature-transition-item feature="{{feature}}"></pt-feature-transition-item>
    </template>

    <pt-days-per-point features="{{features}}"></pt-days-per-point>
  </template>

  <script>
    class PtFeatureTransition extends Polymer.Element {
      static get is() { return "pt-feature-transition"; }
      static get properties() {
        return {
          features: {
            type: Array,
          },
        };
      }
    }

    window.customElements.define(PtFeatureTransition.is, PtFeatureTransition);
  </script>
</dom-module>

<dom-module id="pt-feature-transition-item">
  <template>
    <style is="custom-style">
      .title {
        cursor: pointer;
      }

      .yellow {
        color: var(--google-yellow-500);
      }
    </style>

    <div class="title" on-click="_toggleTransition">
      {{feature.name}} {{feature.estimate}}
      <iron-icon icon="icons:star" class="yellow"></iron-icon>

      <iron-icon icon="icons:expand-more"></iron-icon>
    </div>

    <iron-collapse opened="{{opened}}">
      <table>
        <template is="dom-repeat" items="{{feature.transitions}}" as="transition">
          <tr>
            <td>{{transition.state}}</td>
            <td>{{_momentString(transition.occurred_at)}}</td>
          </tr>
        </template>
      </table>

      <div>
        <pre>
          Insights:

          Estimate: {{feature.estimate}}
          Time From Start to Accepted: {{duration(feature.transitions, "started", "accepted")}}
          Rejected? {{existed(feature.transitions, "rejected")}}

          Days per point: {{daysPerPoint(feature.transitions, "started", "accepted", feature.estimate)}}
        </pre>
      </div>
    </iron-collapse>
  </template>

  <script>
    class PtFeatureTransitionItem extends Polymer.Element {
      static get is() { return "pt-feature-transition-item"; }
      static get properties() {
        return {
          feature: {
            type: Object
          },

          opened: {
            type: Boolean,
            value: false
          }
        };
      }

      _momentString(datestring) {
        return moment(datestring).format("DD MMM YY");
      }

      _toggleTransition(e) {
        this.opened = !this.opened;
      }

      duration(transitions, state1, state2) {
        let duration = this.durationMiliseconds(transitions, state1, state2);

        if (duration) {
          return duration.humanize();
        }
      }

      durationMiliseconds(transitions, state1, state2) {
        let state1Obj = _.filter(transitions, function(t) {
          return t.state == state1;
        })[0];

        let state2Obj = _.filter(transitions, function(t) {
          return t.state == state2;
        })[0];

        if (state1Obj && state2Obj) {
          let timeRange =  moment.duration(moment(state2Obj.occurred_at) - moment(state1Obj.occurred_at));
          return timeRange;
        }
      }

      existed(transitions, state) {
        return !!_.find(transitions, function(t) {
          return t.state == state;
        })
      }

      daysPerPoint(transitions, state1, state2, points) {
        return moment.duration(this.durationMiliseconds(transitions, state1, state2) / points).humanize();
      }
    }

    window.customElements.define(PtFeatureTransitionItem.is, PtFeatureTransitionItem);
  </script>
</dom-module>

<dom-module id="pt-days-per-point">
  <template>
    <h2>Days per point</h2>

    <table>
      <tr>
        <th>Story Name</th>
        <th>Estimate</th>
        <th>Days per point</th>
        <th>Time</th>
      </tr>

      <template is="dom-repeat" items="{{featuresWithDuration}}" as="feature">
        <tr>
          <td>
            {{feature.name}}
          </td>
          <td>
            {{feature.estimate}}
          </td>
          <td>
            {{days(feature.daysPerPoint)}}
          </td>
          <td>
            {{humanize(feature.duration)}}
          </td>
        </tr>
      </template>
    </table>

    <pre>
      Total times spend on developing features {{humanizetotalTimes(featuresWithDuration)}}
      Total point {{totalPoints(features)}}
      ---
      Avg days per point {{humanizeAvgDaysPerPoint(featuresWithDuration)}}
    </pre>
  </template>

  <script>
    class PtDaysPerPoint extends Polymer.Element {
      static get is() { return "pt-days-per-point"; }
      static get properties() {
        return {
          features: {
            type: Array,
            observer: "_calculateFeatureWithDuration"
          },

          featuresWithDuration: {
            type: Array
          }
        };
      }

      _calculateFeatureWithDuration() {
        let $this = this;

        this.featuresWithDuration = _.map(this.features, function(feature) {
          let daysPerPoint = $this.timesPerPoint(feature.transitions, "started", "accepted", feature.estimate);
          let duration = $this.duration(feature.transitions, "started", "accepted");

          return {
            name: feature.name,
            estimate: feature.estimate,
            daysPerPoint: daysPerPoint,
            duration: duration
          };
        });
      }

      /**
        FIXME: duplication with pt-feature-transition
      */
      duration(transitions, state1, state2) {
        let state1Obj = _.filter(transitions, function(t) {
          return t.state == state1;
        })[0];

        let state2Obj = _.filter(transitions, function(t) {
          return t.state == state2;
        })[0];

        if (state1Obj && state2Obj) {
          let timeRange =  moment.duration(moment(state2Obj.occurred_at) - moment(state1Obj.occurred_at));
          return timeRange;
        }
      }

      timesPerPoint(transitions, state1, state2, points) {
        return this.duration(transitions, state1, state2) / points;
      }

      days(duration) {
        return moment.duration(duration).days();
      }

      humanize(duration) {
        return moment.duration(duration).humanize();
      }

      totalTimes(featuresWithDuration) {
        let result = _.reduce(featuresWithDuration, function(sum, feature) {
          return sum + feature.duration;
        }, 0);

        return result;
      }

      totalPoints(features) {
        return _.reduce(features, function(sum, ft) {
          return sum + ft.estimate;
        }, 0);
      }

      humanizetotalTimes(featuresWithDuration) {
        return this.humanize(this.totalTimes(featuresWithDuration));
      }

      avgDaysPerPoint(featuresWithDuration) {
        return this.totalTimes(featuresWithDuration) / 32;
      }

      humanizeAvgDaysPerPoint(featuresWithDuration) {
        return this.humanize(this.avgDaysPerPoint(featuresWithDuration));
      }
    }

    window.customElements.define(PtDaysPerPoint.is, PtDaysPerPoint);
  </script>
</dom-module>
